<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>Terrain</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  
  <body>    
    <script type="text/javascript" src="ThreeExtras.js"></script>
    <script type="text/javascript" src="RequestAnimationFrame.js"></script>

    <script type="text/javascript">
      var SCREEN_WIDTH = window.innerWidth;
      var SCREEN_HEIGHT = window.innerHeight;
      var FLOOR = -1000;

      var container;

      var camera;
      var scene;
      var webglRenderer;

      var renderGl = 1;
      var hasGl = 0;
      
      var rotation = 0;
      
      var cubeMesh;
      var textureCube;

      init();
      animate();
        
      function addMesh(geometry, scale, x, y, z, rx, ry, rz, material) {
        mesh = new THREE.Mesh( geometry, material );
        mesh.scale.x = mesh.scale.y = mesh.scale.z = scale;
        mesh.position.x = x;
        mesh.position.y = y;
        mesh.position.z = z;
        mesh.rotation.x = rx;
        mesh.rotation.y = ry;
        mesh.rotation.z = rz;
        mesh.overdraw = true;
        mesh.doubleSided = false;
        mesh.updateMatrix();
        scene.addObject(mesh);

        return mesh;
      }
        
      function init() {
        container = document.createElement('div');
        document.body.appendChild(container);
        
        var aspect = SCREEN_WIDTH / SCREEN_HEIGHT;

        camera = new THREE.Camera(75, aspect, 1, 100000);
        camera.position.z = 650;
        camera.position.x = 0;
        camera.position.y = FLOOR + 2750;

        scene = new THREE.Scene();

        scene.fog = new THREE.Fog(0x34583e, 0, 10000);

        // LIGHTS
        var ambient = new THREE.AmbientLight(0xffffff);
        scene.addLight(ambient);

        var cube = new Cube( 1, 1, 1, 1, 1 );
        cubeMesh = addMesh( cube, 1,  0, FLOOR, 0, 0,0,0, new THREE.MeshLambertMaterial( { color: 0xFF3333 } ) );
        cubeMesh.visible = false;
        camera.target = cubeMesh;
        
        // terrain
        var img = new Image();
        img.onload = function() {
          var data = getHeightData(img);

          // plane
          plane = new Plane(100, 100, 127, 127);

          for (var i = 0, l = plane.vertices.length; i < l; i++) {
            plane.vertices[i].position.z = data[i];
          }

          var planeMesh = addMesh(plane, 100,  0, FLOOR, 0, -Math.PI / 2,0,0, getTerrainMaterial());
        };
        img.src = "heightmap_128.jpg";

        try {
          webglRenderer = new THREE.WebGLRenderer({ scene: scene, clearColor: 0x34583e, clearAlpha: 0.5 });
          webglRenderer.setFaceCulling(0);
          webglRenderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
          container.appendChild(webglRenderer.domElement);
          hasGl = 1;
        }
        catch (e) {
          alert('no webgl');
          return;
        }
      }

      function getHeightData(img) {
        var canvas = document.createElement('canvas');
        canvas.width = 128;
        canvas.height = 128;
        var context = canvas.getContext('2d');

        var size = 128 * 128, data = new Float32Array(size);

        context.drawImage(img, 0, 0);

        for (var i = 0; i < size; i++) {
          data[i] = 0;
        }

        var imgd = context.getImageData(0, 0, 128, 128);
        var pix = imgd.data;

        var j=0;
        for (var i = 0, n = pix.length; i < n; i += 4) {
          var all = pix[i] + pix[i + 1] + pix[i + 2];
          data[j++] = all / 40;
        }

        return data;
      }

      function getTerrainMaterial() {
        var terrainMaterial = new THREE.MeshPhongMaterial( { map: new THREE.Texture(null, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping), ambient: 0xaaaaaa, specular: 0xffffff, shininess: 1, shading: THREE.SmoothShading } );

        var img = new Image();
        terrainMaterial.map.image = img;
        img.onload = function () {
          terrainMaterial.map.image.loaded = 1;
        };
        img.src = "staticmap.jpeg";

        return terrainMaterial;
      }

      function animate() {
        requestAnimationFrame(animate);
        loop();
      }

      function loop() {
        var dist = 4000;

        camera.position.x = dist * Math.cos(rotation);
        camera.position.z = dist * Math.sin(rotation);
        
        //cubeMesh.position.y = FLOOR + 1500 - (Math.sin(r*5)*1000);
        //cubeMesh.position.x = 500 - (Math.cos(r*5)*1000);
        //cubeMesh.position.z = 500 - (Math.sin(r*5)*1000);

        rotation += 0.0005;

        if (renderGl && hasGl) {
          webglRenderer.render(scene, camera);
        }
      }


    </script>

  </body>
</html>
