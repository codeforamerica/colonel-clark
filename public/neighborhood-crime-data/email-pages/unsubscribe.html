<!DOCTYPE html>

<title>Louisville Neighborhood Crime Data - Unsubscribe</title>
<meta charset='utf-8'>
<script src='/neighborhood-crime-data/ajax.js'></script>
<link href='/neighborhood-crime-data/email-pages/styles.less' rel='stylesheet/less' type='text/css'>
<script src='/less-1.3.0.min.js'></script>

<script>
  function showError() {
    document.querySelector('#loading').classList.remove('visible');
    document.querySelector('#error').classList.add('visible');
  }

  function showSuccess(data) {

    document.querySelector('#loading').classList.remove('visible');

    if (data.neighborhood) {
      document.querySelector('.neighborhood-name').innerHTML = data.neighborhood;
      document.querySelector('#success_existing_subscription').classList.add('visible');
      document.querySelector('.unsubscribe a').setAttribute('href', 'unsubscribe.html?u=' + data.userId);
      document.querySelector('.unsubscribe').classList.remove('invisible');
    } else if (data.neighborhoods && data.neighborhoods.length) {
      var tail = data.neighborhoods.pop();
      if (data.neighborhoods.length > 0) {
        var neighborhoodsMsg = data.neighborhoods.join(", ") + " and " + tail;
      } else {
        var neighborhoodsMsg = tail;
      }

      document.querySelector('.neighborhood-name').innerHTML = neighborhoodsMsg;
      document.querySelector('#success_existing_subscription').classList.add('visible');
    } else {
      document.querySelector('#success_no_subscription').classList.add('visible');
      document.querySelector('.unsubscribe a').setAttribute('href', 'unsubscribe.html?u=' + data.userId);
      document.querySelector('.unsubscribe').classList.remove('invisible');
    }

  }

  function ajaxConfirmation(success, httpRequest) {
    if (success) {
      showSuccess(JSON.parse(httpRequest.response));
    } else {
      showError();
    }
  }

  function main() {
    var url = location.href;

    var idMatch = url.match(/\?(s|u)=([a-z0-9\-]*)/);

    if (!idMatch || !idMatch[1] || !idMatch[2]) {

      showError();
      return;
    }

    var mode = idMatch[1];
    var id = idMatch[2];

    switch (mode) {

      case 's':
        makeAjaxRequest(
          'DELETE', 
          '/api/v1/subscription/' + id,
          null,
          ajaxConfirmation);
        break;

      case 'u':
        makeAjaxRequest(
          'DELETE', 
          '/api/v1/user/' + id + '/subscriptions',
          null,
          ajaxConfirmation);
        break;

    }

  }
</script>

<style>
  .neighborhood-name {
    font-weight: 600;
  }
</style>

<body>
  <header>
    <img alt='Neighborhood crime data' id='logo' src='/neighborhood-crime-data/images/logo-retina.png'>
  </header>
  <div id='loading' class='visible'>
    <h3>
      Loading…
    </h3>
  </div>
  <div id='error'>
    <h3>
      Unsubscribe failed.
    </h3>
    <p>
      Something went wrong. You can refresh the page to try again.
    </p>
  </div>
  <div id='success_existing_subscription'>
    <p>
      You have been unsubscribed. You will no longer receive weekly summary emails
      for <span class='neighborhood-name'>Blah blah blah</span>.
    </p>
  </div>
  <div id='success_no_subscription'>
    <p>
      Looks like you were already unsubscribed. You are all set!
    </p>
  </div>

  <footer>
    <a href='mailto:louisville@codeforamerica.org'>Contact us</a> 
    <span class='unsubscribe invisible'>
      · <a href=''>Unsubscribe from all emails</a>
    </span>
  </footer>

  <noscript>
    Please enable JavaScript to finish the verification process.
  </noscript>

  <script>
    main();
  </script>
</body>
