<!DOCTYPE html>

<meta charset='utf-8'>

<script src='http://d3js.org/d3.v3.min.js'></script>

<style>
  .chart {
  }
  .chart rect {
    stroke: white;
    fill: steelblue;
  }
  .chart .label {
    font-family: Arial;
    font-size: 12px;
    fill: black;
    text-anchor: end;
  }
  .chart .value {
    font-family: Arial;
    font-size: 12px;
    fill: white;
    text-anchor: end;
  }
</style>

<script>
  var dataLabels = ['A', 'B', 'C', 'D', 'E'];

  var data = [100, 50, 23, 78, 120];
  var data2 = [80, 30, 43, 98, 70];

  var LABEL_WIDTH = 200;
  var CHART_WIDTH = 420;
  var BAR_HEIGHT = 20;

  var DURATION_TIME = 1000;

  var chart;
  var chartScale;

  var currentData;
  var currentDataOrdering;

  function calculateDataOrder() { 
    currentDataOrdering = [];
    for (var i = 0; i < currentData.length; i++) {
      currentDataOrdering.push(i);
    }
    currentDataOrdering.sort(function(a, b) {
      return currentData[b] - currentData[a];
    });
  }

  function prepareChart() {
    chart = d3.select("body").append("svg")
        .attr("class", "chart")
        .attr("width", LABEL_WIDTH + CHART_WIDTH)
        .attr("height", 20 * data.length);   

    chartScale = d3.scale.linear()
        .domain([0, d3.max(data)])
        .range([0, CHART_WIDTH]);

    currentData = data;
    calculateDataOrder();

    chart.selectAll("rect")
        .data(currentData)
        .enter().append("rect")
        .attr("x", LABEL_WIDTH)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT; })
        .attr("width", chartScale)
        .attr("height", BAR_HEIGHT);

    chart.selectAll("text.label")
        .data(dataLabels)
        .enter().append("text")
        .attr("class", "label")
        .attr("x", 0)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT - 5; })
        .attr("dx", LABEL_WIDTH - 3) // padding-right
        .attr("dy", BAR_HEIGHT) // vertical-align: middle
        .text(String);             

    chart.selectAll("text.value")
        .data(currentData)
        .enter().append("text")
        .attr("class", "value")
        .attr("x", chartScale)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT - 5; })
        .attr("dx", LABEL_WIDTH - 3) // padding-right
        .attr("dy", BAR_HEIGHT) // vertical-align: middle
        .text(String);             
  }

  function change() {
    currentData = data2;
    calculateDataOrder();

    chart.selectAll("rect")
        .data(currentData)
        .transition()
        .duration(DURATION_TIME)
        .attr("width", chartScale)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT; });

    chart.selectAll("text.label")
        .data(currentData)
        .transition()
        .duration(DURATION_TIME)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT - 5; })

    chart.selectAll("text.value")
        .data(currentData)
        .transition()
        .duration(DURATION_TIME)
        .attr("x", chartScale)
        .attr("y", function(d, i) { return currentDataOrdering.indexOf(i) * BAR_HEIGHT - 5; })
        .tween("text", function(d) {
          // TODO(mwichary): Must be a better way to do this.
          var i = d3.interpolateNumber(parseInt(this.textContent), d);
          return function(t) {
            this.textContent = parseInt(i(t));
          };
        });
  }

  function main() {
    prepareChart();
  }
</script>

<body>

  <button onclick='change()'>Change</button>

  <script>
    main();
  </script>
</body>
